# Discord

## MVP
 1. Авторизация/регистрация;
 2. Парные звонки;
 3. Групповые звонки.

## Целевая аудитория и нагрузка
 - Ежемесячный онлайн ~45 млн. пользователей. Месяный трафик голосового чата составляет около 15 петабайт (15340 терабайт);
 - Ежедневный онлайн ~8,9 млн. человек. Пиковое значение одновременно общающихся пользователей 4 млн;
 - 1,2 млрд. минут общения в день;
 - Северная Америка, Россия, Европа.

## Расчет нагрузки

Используя данные выше, посчитаем количество минут голосового общения в месяц:

    1,2 млрд. * 30 = 36 млрд. минут/месяц
    
Зная месяный трафик голосового чата, посчитаем суммарный суточный трафик соответственно:

    15340 * 1024 / 30 = 523605 Гбайт/сутки
    
Из устаревшей [статистики](https://habr.com/ru/post/423171/) "Discord способен обслуживать одновременно более 2,6 миллиона пользователей голосового чата с исходящим трафиком более 220 Гбит/с", получим пропорционально нашей пиковой суточной нагрузке:

    220 * 4 / 2,6 = 338 Гбит/с
    
Итого мы получаем по сетевому трафику:
 * Суммарный суточный - 523605 Гбайт/сутки;
 * Пиковое значение в течении суток - 338 Гбит/с.
    
Так как большее количество пользователей пользуются приложением десктопно или на мобильных устройствах, то можно предположить что в день пользователь 0,25 раз логинится, следовательно в день количество запросов на запись в хранилище сессий:

    8,9 млн. * 0,25 / 24 / 3600 = 26 RPS
    
Посчитаем количество звонков совершаемых в день, полагая, что средняя длительность звонка 2 часа:

    1,2 млрд / 120 = 10 млн. звонков/день

Допустим, что в одном звонке в среднем участвуют 4 человека. На 1 звонок приходится 10 операций: создание звонка, 4 подключения, 4 отключения, обрывание звонка.
Тогда получим, что нагрузка на хранилище звонков в среднем за сутки равна:

    10 млн * 10 / 24 / 3600 = 1157 RPS

Итого мы получаем по средней суточной нагрузке на хранилища:
 * Хранилище сессий - 26 RPS;
 * Хранилище звонков - 1157 RPS.

## Логическая схема БД

Сущности:
 1. Пользователь;
 2. Звонок;
 3. Сессия;
 4. ПользовательЗвонок.

![](https://sun9-20.userapi.com/impg/JouYkxWKDFl9t-kQEUE9QsicSM_2coRmiKRNAQ/1ovbyFuxWzU.jpg?size=839x484&quality=96&sign=b6461f8c7dbc723fa464e5714cf6c437&type=album)

## Физическая схема БД

Так как суммарный вес у нас не превысит и сотни гигабайт даже в пиковые моменты нагрузки, то можем все хранить в PostgreSQL.

## Выбор технологий

Весь бэкенд будет написан на Go(несмотря на то, что сам Discord уже давно потихоньку переезжает на Rust). По-моему мнению стоит разделить весь бэк на 2 независимых сервиса: сервис авторизации и управления звонками и сервис хост звонков. Фронтенд с сервисом авторизации общается непосредственно по HTTP и будет заниматься, логично авторизацией. 

Хост звонков необходим для нормального общения большого количества человек. Он занимается загрузкой и раздачей аудио. Их можно разделить на 2 отдельны микросервиса, но стратовать будем в рамках одной машины. Общение с сервисом будет происходить по UDP. 

## Схема работы

![](https://sun9-46.userapi.com/impg/5vTb7GHycZrTl7z7xbvjPS-RGsw69Eul8f2DYw/dvSdLw2uZ18.jpg?size=1025x494&quality=96&sign=2be794e2037d5cf780ad700f2432981b&type=album)

Узким местом в проектировании сервиса является сервер-хост звонков. Имеено для него дальше проведем расчет по железу.

Нагрузка впитываемая сетевой картой равна 10 Гбит/с, следовательно исходя из нашего пикового трафика, получается нам необходимо 34 сетевые карты, но если учесть небольшой запас, то 40 сетевых карт будет достаточно, а это 20 компьютеров.

В оперативной памяти нам нужно хранить 2535 Гбайт аудио при пиковой нагрузке суммарно. В пересчете на один звонок, получается 2,6 Мбайт.

## Итоговая табличка

| Роль                                     | Ядра CPU | ОЗУ       | Жёсткий диск | Количество |
| ---------------------------------------- | -------  | --------- | ------------ | ---------- |
| Сервис авторизации и управления звонками | 14       | 16 Гбайт  | 480 Гбайт    | 4          |
| СУБД                                     | 14       | 6 Гбайт   | 1 Тб         | 1          |
| СУБД (реплика)                           | 14       | 6 Гбайт   | 1 Тб         | 1          |
| Хост звонков                             | 96       | 128 Гбайт | 480 Гбайт    | 20         |

## Схема балансировки

Вкратце, нам нужно определить наименее удаленный от пользователя сервер, если это сервер загружен, то мы просто выбираем следующий. 

При создании звонка, выстраиваем список серверов, отсортированных по возрастанию удаленности от пользователя. Далее выбираем первый и подсчитываем количество активных звонков на нем. Если оно максимально возможное, то смотрим на следующий сервер. Так, пока не находим подходящий. В итоге передаем айпишник сервера пользователю и назначаем его в базе для созданной конференции.

## Источники информации:
 - https://app2top.ru/industry/igrovoe-chat-prilozhenie-discord-ispol-zuyut-45-mln-chelovek-101159.html
 - https://discord.com/company
